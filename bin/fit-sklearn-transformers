#!/usr/bin/env python

from sklearn.decomposition import (FastICA, IncrementalPCA, KernelPCA, NMF,
                                   TruncatedSVD, PCA)
import sys, os
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), "..")))
import pickle
from datasets import mnist

def name(transformer):
    n_components = transformer.n_components
    return f"{transformer.__class__.__name__.lower()}-{n_components}"

X_train, _, _, _ = mnist()

transformers = []
classes = [FastICA, IncrementalPCA, KernelPCA, NMF, TruncatedSVD, PCA]
for n_components in [784, 331, 100, 80, 60, 20]:
    for c in classes:
        if c is TruncatedSVD and n_components == 784:
            continue

        if c is KernelPCA:
            transformer = c(n_components=n_components, fit_inverse_transform=True)
        else:
            transformer = c(n_components=n_components)

        transformers.append(transformer)

for transformer in transformers:
    print(f"Fitting {transformer}...", end="")
    sys.stdout.flush()
    transformer.fit(X_train.reshape(-1, 784))
    print()

os.makedirs("cache/", exist_ok=True)
for transformer in transformers:
    filename = f"cache/{name(transformer)}.pkl"
    with open(filename, "wb") as f:
        pickle.dump(transformer, f)
